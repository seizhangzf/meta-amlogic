From 7d0436d8b2ffc419bb453d6d5a5149af747ce2c0 Mon Sep 17 00:00:00 2001
From: "ufo.chang" <ufo.chang@amlogic.com>
Date: Fri, 4 Oct 2019 17:53:47 +0800
Subject: [PATCH 1/2] Adjust DDR timing for LPDDR4

Change-Id: I3e094bbd8d208fc9e7b708241b397c4c698b93f8
Signed-off-by: Ufo Chang <ufo.chang@amlogic.com>
---
 .../amlogic/tm2_t962x3_ab301_v1/firmware/timing.c  | 96 ++++++++++++++++++----
 1 file changed, 79 insertions(+), 17 deletions(-)

diff --git a/board/amlogic/tm2_t962x3_ab301_v1/firmware/timing.c b/board/amlogic/tm2_t962x3_ab301_v1/firmware/timing.c
index 03c76a3..de201d8 100644
--- a/board/amlogic/tm2_t962x3_ab301_v1/firmware/timing.c
+++ b/board/amlogic/tm2_t962x3_ab301_v1/firmware/timing.c
@@ -60,6 +60,66 @@
 
 ddr_set_t __ddr_setting[] = {
 {
+	//lpddr4
+	.board_id				= CONFIG_BOARD_ID_MASK,
+	.version				= 1,
+	//.dram_rank_config		= CONFIG_DDR0_32BIT_RANK01_CH0,
+	.dram_rank_config		= CONFIG_DDR0_32BIT_RANK01_CH0,
+	.ddr_rfc_type			= DDR_RFC_TYPE_LPDDR4_8Gbx1,
+	.DramType				= CONFIG_DDR_TYPE_LPDDR4,
+	.DRAMFreq				= {1008, 0, 0, 0},
+	.ddr_base_addr			= CFG_DDR_BASE_ADDR,
+	.ddr_start_offset		= CFG_DDR_START_OFFSET,
+	.DisabledDbyte			= 0xf0,
+	.Is2Ttiming				= 0,
+	.HdtCtrl				= 0xa,
+	.dram_cs0_size_MB		= 0xffff,//1024,
+	.dram_cs1_size_MB		= 0xffff,//1024,
+	.training_SequenceCtrl	= {0x131f,0x61}, //ddr3 0x21f 0x31f
+	.phy_odt_config_rank	= {0x0,0x0}, //use 0x23 0x13  compatibility with 1rank and 2rank //targeting rank 0. [3:0] is used //for write ODT [7:4] is used for //read ODT
+	.dfi_odt_config			= 0x0d0d,  //use 0d0d compatibility with 1rank and 2rank  //0808
+	.PllBypassEn			= 0, //bit0-ps0,bit1-ps1
+	.ddr_rdbi_wr_enable		= 0x3,
+	.clk_drv_ohm			= 40,
+	.cs_drv_ohm				= 40,
+	.ac_drv_ohm				= 60,
+	.soc_data_drv_ohm_p		= 48,
+	.soc_data_drv_ohm_n		= 48,
+	.soc_data_odt_ohm_p		= 0,
+	.soc_data_odt_ohm_n		= 48,
+	.dram_data_drv_ohm		= 48, //lpddr4 sdram only240/1-6
+	.dram_data_odt_ohm		= 48,
+	.dram_ac_odt_ohm		= 240,//120,// 120,
+	.lpddr4_dram_vout_voltage_1_3_2_5_setting   = 1,///1, 1/3vddq     0 2/5 vddq
+	.soc_clk_slew_rate		= 0x3ff,//0x253,
+	.soc_cs_slew_rate		= 0x100,//0x253,
+	.soc_ac_slew_rate		= 0x100,//0x253,
+	.soc_data_slew_rate		= 0x1ff,
+	.vref_output_permil		=300,// 260,//200,
+	.vref_receiver_permil	= 150,
+	.vref_dram_permil		= 0,
+	//.vref_reverse			= 0,
+	.ac_trace_delay			= {32,32,16,16,0,0,0x0,00},
+	//.ac_pinmux				= {00,00},
+	.ddr_dmc_remap			= {
+							[0] = ( 5 |  6 << 5 |  7 << 10 |  8<< 15 | 9<< 20 | 10 << 25 ),
+							[1] = ( 11|  0 << 5 |  0 << 10 | 15 << 15 | 16 << 20 | 17 << 25 ),
+							[2] = ( 18| 19 << 5 | 20 << 10 | 21 << 15 | 22 << 20 | 23 << 25 ),
+							[3] = ( 24| 25 << 5 | 26 << 10 | 27 << 15 | 28 << 20 | 29 << 25 ),
+							[4] = ( 30| 12 << 5 | 13 << 10 |  14<< 15 |  0 << 20 |  0 << 25 ),
+	},
+	.ddr_lpddr34_ca_remap	= {00,00},
+	//.ddr_lpddr34_dq_remap	= {4,5,6,7,0,2,3,1,  15,14,13,12,11,9,10,8,   20,18,17,16,23,22,19,21,   30,31,25,24,26,28,29,27},
+	.ddr_lpddr34_dq_remap	= {4,5,6,7,1,2,0,3,  15,14,10,8,11,9,13,12,   20,18,17,16,23,22,19,21,   30,31,25,24,26,28,29,27},
+	.dram_rtt_nom_wr_park	= {00,00},
+	.pll_ssc_mode			= (1<<20) | (1<<8) | (2<<4) | 0,//center_ssc_1000ppm
+	.ddr_func				= DDR_FUNC,
+	.magic					= DRAM_CFG_MAGIC,
+	.diagnose				= CONFIG_DIAGNOSE_DISABLE,
+	.bitTimeControl_2d		= 1,	//training time setting,=1,200ms;=7,2s
+	.fast_boot[0]			= 1,
+},
+{
 	//tl1 ref(T309) lpddr4
 	.board_id				= CONFIG_BOARD_ID_MASK,
 	.version				= 1,
@@ -67,7 +127,7 @@ ddr_set_t __ddr_setting[] = {
 	.dram_rank_config		= CONFIG_DDR0_32BIT_RANK0_CH0,
 	.ddr_rfc_type			= DDR_RFC_TYPE_LPDDR4_8Gbx1,
 	.DramType				= CONFIG_DDR_TYPE_LPDDR4,
-	.DRAMFreq				= {1200, 0, 0, 0},
+	.DRAMFreq				= {1008, 0, 0, 0},
 	.ddr_base_addr			= CFG_DDR_BASE_ADDR,
 	.ddr_start_offset		= CFG_DDR_START_OFFSET,
 	.DisabledDbyte			= 0xf0,
@@ -76,30 +136,30 @@ ddr_set_t __ddr_setting[] = {
 	.dram_cs0_size_MB		= 0xffff,//1024,
 	.dram_cs1_size_MB		= 0,//1024,
 	.training_SequenceCtrl	= {0x131f,0x61}, //ddr3 0x21f 0x31f
-	.phy_odt_config_rank	= {0x23,0x13}, //use 0x23 0x13  compatibility with 1rank and 2rank //targeting rank 0. [3:0] is used //for write ODT [7:4] is used for //read ODT
+	.phy_odt_config_rank	= {0x0,0x0}, //use 0x23 0x13  compatibility with 1rank and 2rank //targeting rank 0. [3:0] is used //for write ODT [7:4] is used for //read ODT
 	.dfi_odt_config			= 0x0d0d,  //use 0d0d compatibility with 1rank and 2rank  //0808
 	.PllBypassEn			= 0, //bit0-ps0,bit1-ps1
 	.ddr_rdbi_wr_enable		= 0x3,
-	.clk_drv_ohm			= 60,
+	.clk_drv_ohm			= 40,
 	.cs_drv_ohm				= 40,
 	.ac_drv_ohm				= 60,
 	.soc_data_drv_ohm_p		= 48,
 	.soc_data_drv_ohm_n		= 48,
 	.soc_data_odt_ohm_p		= 0,
-	.soc_data_odt_ohm_n		= 60,
+	.soc_data_odt_ohm_n		= 48,
 	.dram_data_drv_ohm		= 48, //lpddr4 sdram only240/1-6
-	.dram_data_odt_ohm		= 120,
-	.dram_ac_odt_ohm		= 120,// 120,
-	.lpddr4_dram_vout_voltage_1_3_2_5_setting   =0,///1, 1/3vddq     0 2/5 vddq
+	.dram_data_odt_ohm		= 48,
+	.dram_ac_odt_ohm		= 240,//120,// 120,
+	.lpddr4_dram_vout_voltage_1_3_2_5_setting   = 1,///1, 1/3vddq     0 2/5 vddq
 	.soc_clk_slew_rate		= 0x3ff,//0x253,
 	.soc_cs_slew_rate		= 0x100,//0x253,
 	.soc_ac_slew_rate		= 0x100,//0x253,
 	.soc_data_slew_rate		= 0x1ff,
-	.vref_output_permil		= 260,//200,
-	.vref_receiver_permil	= 0,
+	.vref_output_permil		=300,// 260,//200,
+	.vref_receiver_permil	= 150,
 	.vref_dram_permil		= 0,
 	//.vref_reverse			= 0,
-	//.ac_trace_delay			= {32-5,0,0,0,0,0,0x0,00},
+	.ac_trace_delay			= {32,32,16,16,0,0,0x0,00},
 	//.ac_pinmux				= {00,00},
 	.ddr_dmc_remap			= {
 							[0] = ( 5 |  6 << 5 |  7 << 10 |  8<< 15 | 9<< 20 | 10 << 25 ),
@@ -109,16 +169,17 @@ ddr_set_t __ddr_setting[] = {
 							[4] = ( 30| 12 << 5 | 13 << 10 |  14<< 15 |  0 << 20 |  0 << 25 ),
 	},
 	.ddr_lpddr34_ca_remap	= {00,00},
-	//.ddr_lpddr34_dq_remap	= {4,5,6,7,0,2,3,1,  15,14,13,12,11,9,10,8, 4,5,6,7,0,2,3,1,  15,14,13,12,11,9,10,8,},
-	.ddr_lpddr34_dq_remap	= {4,5,6,7,0,2,3,1,  15,14,13,12,11,9,10,8,   20,18,17,16,23,22,19,21,   30,31,25,24,26,28,29,27},
+	//.ddr_lpddr34_dq_remap	= {4,5,6,7,0,2,3,1,  15,14,13,12,11,9,10,8,   20,18,17,16,23,22,19,21,   30,31,25,24,26,28,29,27},
+	.ddr_lpddr34_dq_remap	= {4,5,6,7,1,2,0,3,  15,14,10,8,11,9,13,12,   20,18,17,16,23,22,19,21,   30,31,25,24,26,28,29,27},
 	.dram_rtt_nom_wr_park	= {00,00},
 	.pll_ssc_mode			= (1<<20) | (1<<8) | (2<<4) | 0,//center_ssc_1000ppm
 	.ddr_func				= DDR_FUNC,
 	.magic					= DRAM_CFG_MAGIC,
 	.diagnose				= CONFIG_DIAGNOSE_DISABLE,
 	.bitTimeControl_2d		= 1,	//training time setting,=1,200ms;=7,2s
-	.fast_boot[0]			= 0,
+	.fast_boot[0]			= 1,
 },
+#if 0
 {
 	/// tl1 ref(x301) ddr3
 	.board_id				=CONFIG_BOARD_ID_MASK,
@@ -143,7 +204,7 @@ ddr_set_t __ddr_setting[] = {
 	.ac_drv_ohm				= 60,
 	.soc_data_drv_ohm_p		= 40,
 	.soc_data_drv_ohm_n		= 40,
-	.soc_data_odt_ohm_p		= 48,//120, //48, ddr3 will use odt_ohm_p value
+	.soc_data_odt_ohm_p		= 60,//120, //48, ddr3 will use odt_ohm_p value
 	.soc_data_odt_ohm_n		= 0,//120,
 	.dram_data_drv_ohm		= 40, //ddr4 sdram only 34 or 48, skt board use 34 better
 	.dram_data_odt_ohm		= 40,
@@ -190,6 +251,7 @@ ddr_set_t __ddr_setting[] = {
 	.magic					= DRAM_CFG_MAGIC,
 	.fast_boot[0]			= 0,
 },
+#endif
 //*/
 {
 	/* tl1 skt (x309) ddr4 */
@@ -230,7 +292,7 @@ ddr_set_t __ddr_setting[] = {
 	.vref_dram_permil		= 0,
 	//.vref_reverse			= 0,
 	//.ac_trace_delay			={0x0,0x0},// {0x40,0x40,0x40,0x40,0x40,0x40,0x40,0x40,0x40,0x40},
-	.ac_trace_delay			= {32+10,32+10,32+10,32+10,32,32+10,32+10,32+10,32+10,32+10},
+	.ac_trace_delay			= {18,32+22,32+25,32+24,32,32+16,32+25,32+24,32+26,32+15},
 	.ddr_dmc_remap			= {
 							[0] = ( 5 |  7 << 5 |  8 << 10 |  9 << 15 | 10 << 20 | 11 << 25 ),
 							[1] = ( 12|  0 << 5 |  0 << 10 | 14 << 15 | 15 << 20 | 16 << 25 ),
@@ -644,9 +706,9 @@ bl2_reg_t __bl2_reg[] = {
 	{AO_PWM_PWM_B,        VDDEE_VAL_REG,           0xffffffff,   0, BL2_INIT_STAGE_1, 0},
 	{AO_PWM_MISC_REG_AB,  ((1 << 23) | (1 << 1)),  (0x7f << 16), 0, BL2_INIT_STAGE_1, 0},
 	{AO_PIN_MUX_REG1,     (3 << 16),               (0xF << 16),  0, BL2_INIT_STAGE_1, 0},
-	/* Enable 5V_EN ,set gpioao_3 low --> several millisecond--set high in board_init*/
+	/* Enable 5V_EN */
 	{AO_GPIO_O_EN_N,    (0 << 3),                (1 << 3),     0, BL2_INIT_STAGE_1, 0},
-	{AO_GPIO_O,         (0 << 3),                (1 << 3),   0, BL2_INIT_STAGE_1, 0},
+	{AO_GPIO_O,         (1 << 3),                (1 << 3),   0, BL2_INIT_STAGE_1, 0},
 	/* Enable VCCK GPIOAO_2*/
 	{AO_GPIO_O_EN_N,      (0 << 2),                (1 << 2),  	 0, BL2_INIT_STAGE_1, 0},
 	{AO_GPIO_O,           (1 << 2),                (1 << 2),  	 0, BL2_INIT_STAGE_1, 0},
-- 
2.7.4

