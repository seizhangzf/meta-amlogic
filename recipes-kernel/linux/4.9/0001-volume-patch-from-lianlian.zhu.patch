From 60e64abba38e74c60154ed7141d8ab20f045a550 Mon Sep 17 00:00:00 2001
From: Mingyen Hung <mingyen.hung@amlogic.com>
Date: Fri, 5 Oct 2018 10:53:38 +0800
Subject: [PATCH] volume-patch-from-lianlian.zhu

---
 sound/soc/amlogic/meson/i2s.c | 173 +++++++++++++++++++++++++++++++++---------
 sound/soc/amlogic/meson/i2s.h |   9 +++
 2 files changed, 147 insertions(+), 35 deletions(-)

diff --git a/sound/soc/amlogic/meson/i2s.c b/sound/soc/amlogic/meson/i2s.c
index af1dcbddfd19..73a2b787e172 100644
--- a/sound/soc/amlogic/meson/i2s.c
+++ b/sound/soc/amlogic/meson/i2s.c
@@ -60,6 +60,9 @@
 #define XRUN_NUM 10 /*10ms*10=100ms timeout*/
 #endif
 
+#define VOLUME_SCALE	100
+#define VOLUME_SHIFT	15
+#define VOL_CTL(s) ((unsigned int)(((signed short)(s))*(vol))>>VOLUME_SHIFT)
 unsigned long aml_i2s_playback_start_addr;
 EXPORT_SYMBOL(aml_i2s_playback_start_addr);
 
@@ -77,6 +80,21 @@ EXPORT_SYMBOL(aml_i2s_playback_format);
 
 unsigned int aml_i2s_playback_running_flag;
 EXPORT_SYMBOL(aml_i2s_playback_running_flag);
+static struct audio_mixer_control audio_mixer_ctl;
+int get_mixer_output_volume(void)
+{
+	int val;
+
+	val = audio_mixer_ctl.output_volume;
+	return val;
+}
+
+int set_mixer_output_volume(int volume)
+{
+	audio_mixer_ctl.output_volume = volume;
+	return 0;
+}
+
 
 static int trigger_underrun;
 void aml_audio_hw_trigger(void)
@@ -757,6 +775,8 @@ static int aml_i2s_copy_playback(struct snd_pcm_runtime *runtime, int channel,
 	struct aml_audio_buffer *tmp_buf = buffer->private_data;
 	struct audio_stream *s = &prtd->s;
 	struct device *dev = substream->pcm->card->dev;
+	register unsigned int vol =
+		(audio_mixer_ctl.output_volume*(1<<VOLUME_SHIFT))/VOLUME_SCALE;
 #ifndef CONFIG_AMLOGIC_SND_SPLIT_MODE
 	void *ubuf = tmp_buf->buffer_start;
 	int i = 0, j = 0;
@@ -824,9 +844,19 @@ static int aml_i2s_copy_playback(struct snd_pcm_runtime *runtime, int channel,
 
 	if (access_ok(VERIFY_READ, buf, frames_to_bytes(runtime, count))) {
 #ifdef CONFIG_AMLOGIC_SND_SPLIT_MODE
-		res = copy_from_user(hwbuf, buf, n);
-		if (res)
-			return -EFAULT;
+		if (runtime->format == SNDRV_PCM_FORMAT_S16_LE) {
+			int16_t *tfrom, *to;
+			int i = 0;
+
+			tfrom = (int16_t *) buf;
+			to = (int16_t *) hwbuf;
+			for (i = 0; i < n/2; i++)
+				*to++ = (int16_t)(VOL_CTL(*tfrom++));
+		} else {
+			res = copy_from_user(hwbuf, buf, n);
+			if (res)
+				return -EFAULT;
+		}
 #else
 		if (runtime->format == SNDRV_PCM_FORMAT_S16_LE) {
 			int16_t *tfrom, *to;
@@ -848,14 +878,22 @@ static int aml_i2s_copy_playback(struct snd_pcm_runtime *runtime, int channel,
 				sbr = to + 16 * 7;
 				for (j = 0; j < n; j += 256) {
 					for (i = 0; i < 16; i++) {
-						*lf++ = (*tfrom++);
-						*cf++ = (*tfrom++);
-						*rf++ = (*tfrom++);
-						*ls++ = (*tfrom++);
-						*rs++ = (*tfrom++);
-						*lef++ = (*tfrom++);
-						*sbl++ = (*tfrom++);
-						*sbr++ = (*tfrom++);
+						*lf++ =
+						    (int16_t)VOL_CTL(*tfrom++);
+						*cf++ =
+						    (int16_t)VOL_CTL(*tfrom++);
+						*rf++ =
+						    (int16_t)VOL_CTL(*tfrom++);
+						*ls++ =
+						    (int16_t)VOL_CTL(*tfrom++);
+						*rs++ =
+						    (int16_t)VOL_CTL(*tfrom++);
+						*lef++ =
+						    (int16_t)VOL_CTL(*tfrom++);
+						*sbl++ =
+						    (int16_t)VOL_CTL(*tfrom++);
+						*sbr++ =
+						    (int16_t)VOL_CTL(*tfrom++);
 					}
 					lf += 7 * 16;
 					cf += 7 * 16;
@@ -874,8 +912,10 @@ static int aml_i2s_copy_playback(struct snd_pcm_runtime *runtime, int channel,
 
 				for (j = 0; j < n; j += 64) {
 					for (i = 0; i < 16; i++) {
-						*left++ = (*tfrom++);
-						*right++ = (*tfrom++);
+						*left++ =
+						    (int16_t)VOL_CTL(*tfrom++);
+						*right++ =
+						    (int16_t)VOL_CTL(*tfrom++);
 					}
 					left += 16;
 					right += 16;
@@ -902,14 +942,22 @@ static int aml_i2s_copy_playback(struct snd_pcm_runtime *runtime, int channel,
 				sbr = to + 8 * 7;
 				for (j = 0; j < n; j += 256) {
 					for (i = 0; i < 8; i++) {
-						*lf++ = (*tfrom++);
-						*cf++ = (*tfrom++);
-						*rf++ = (*tfrom++);
-						*ls++ = (*tfrom++);
-						*rs++ = (*tfrom++);
-						*lef++ = (*tfrom++);
-						*sbl++ = (*tfrom++);
-						*sbr++ = (*tfrom++);
+						*lf++ =
+						    (int32_t)VOL_CTL(*tfrom++);
+						*cf++ =
+						    (int32_t)VOL_CTL(*tfrom++);
+						*rf++ =
+						    (int32_t)VOL_CTL(*tfrom++);
+						*ls++ =
+						    (int32_t)VOL_CTL(*tfrom++);
+						*rs++ =
+						    (int32_t)VOL_CTL(*tfrom++);
+						*lef++ =
+						    (int32_t)VOL_CTL(*tfrom++);
+						*sbl++ =
+						    (int32_t)VOL_CTL(*tfrom++);
+						*sbr++ =
+						    (int32_t)VOL_CTL(*tfrom++);
 					}
 					lf += 7 * 8;
 					cf += 7 * 8;
@@ -928,8 +976,10 @@ static int aml_i2s_copy_playback(struct snd_pcm_runtime *runtime, int channel,
 
 				for (j = 0; j < n; j += 64) {
 					for (i = 0; i < 8; i++) {
-						*left++ = (*tfrom++);
-						*right++ = (*tfrom++);
+						*left++ =
+						    (int32_t)VOL_CTL(*tfrom++);
+						*right++ =
+						    (int32_t)VOL_CTL(*tfrom++);
 					}
 					left += 8;
 					right += 8;
@@ -956,14 +1006,22 @@ static int aml_i2s_copy_playback(struct snd_pcm_runtime *runtime, int channel,
 				sbr = to + 8 * 7;
 				for (j = 0; j < n; j += 256) {
 					for (i = 0; i < 8; i++) {
-						*lf++ = (*tfrom++) >> 8;
-						*cf++ = (*tfrom++) >> 8;
-						*rf++ = (*tfrom++) >> 8;
-						*ls++ = (*tfrom++) >> 8;
-						*rs++ = (*tfrom++) >> 8;
-						*lef++ = (*tfrom++) >> 8;
-						*sbl++ = (*tfrom++) >> 8;
-						*sbr++ = (*tfrom++) >> 8;
+						*lf++ = (int32_t)
+						    VOL_CTL((*tfrom++) >> 8);
+						*cf++ = (int32_t)
+						    VOL_CTL((*tfrom++) >> 8);
+						*rf++ = (int32_t)
+						    VOL_CTL((*tfrom++) >> 8);
+						*ls++ = (int32_t)
+						    VOL_CTL((*tfrom++) >> 8);
+						*rs++ = (int32_t)
+						    VOL_CTL((*tfrom++) >> 8);
+						*lef++ = (int32_t)
+						    VOL_CTL((*tfrom++) >> 8);
+						*sbl++ = (int32_t)
+						    VOL_CTL((*tfrom++) >> 8);
+						*sbr++ = (int32_t)
+						    VOL_CTL((*tfrom++) >> 8);
 					}
 					lf += 7 * 8;
 					cf += 7 * 8;
@@ -982,8 +1040,10 @@ static int aml_i2s_copy_playback(struct snd_pcm_runtime *runtime, int channel,
 
 				for (j = 0; j < n; j += 64) {
 					for (i = 0; i < 8; i++) {
-						*left++ = (*tfrom++) >> 8;
-						*right++ = (*tfrom++) >> 8;
+						*left++ = (int32_t)
+						    VOL_CTL((*tfrom++) >> 8);
+						*right++ = (int32_t)
+						    VOL_CTL((*tfrom++) >> 8);
 					}
 					left += 8;
 					right += 8;
@@ -1352,6 +1412,35 @@ static int aml_i2s_probe(struct snd_soc_platform *platform)
 			aml_i2s_controls, ARRAY_SIZE(aml_i2s_controls));
 }
 
+static ssize_t show_volume(struct class *class,
+		struct class_attribute *attr, char *buf)
+{
+	ssize_t size = sprintf(buf, "volume=%d\n",
+			audio_mixer_ctl.output_volume);
+	return size;
+}
+
+static ssize_t store_volume(struct class *class, struct class_attribute *attr,
+		const char *buf, size_t size) {
+	unsigned int val;
+	ssize_t ret;
+
+	ret = kstrtoint(buf, 10, &val);
+
+	if (ret != 0)
+		return -EINVAL;
+
+	if ((val >= 0) && (val <= 100))
+		audio_mixer_ctl.output_volume = val;
+
+	return size;
+}
+
+static struct class_attribute aml_i2s_class_attrs[] = {
+	__ATTR(volume, 0644, show_volume, store_volume),
+	__ATTR_NULL
+};
+
 struct snd_soc_platform_driver aml_soc_platform = {
 	.probe = aml_i2s_probe,
 	.ops = &aml_i2s_ops,
@@ -1361,13 +1450,27 @@ struct snd_soc_platform_driver aml_soc_platform = {
 
 static int aml_soc_platform_probe(struct platform_device *pdev)
 {
-	return snd_soc_register_platform(&pdev->dev, &aml_soc_platform);
+	int ret = 0;
+
+	snd_soc_register_platform(&pdev->dev, &aml_soc_platform);
+	pr_info("enter aml_soc_platform_probe\n");
+	audio_mixer_ctl.output_volume = 100;
+
+	audio_mixer_ctl.aml_i2s_class.name = "aml_i2s";
+	audio_mixer_ctl.aml_i2s_class.class_attrs = aml_i2s_class_attrs;
+	ret = class_register(&audio_mixer_ctl.aml_i2s_class);
+	if (ret)
+		pr_err("aml_i2s_class register fail\n");
+
+	pr_info("registed audio mixer controls class\n");
+
+	return ret;
 }
 
 static int aml_soc_platform_remove(struct platform_device *pdev)
 {
 	snd_soc_unregister_platform(&pdev->dev);
-
+	class_unregister(&audio_mixer_ctl.aml_i2s_class);
 	return 0;
 }
 
diff --git a/sound/soc/amlogic/meson/i2s.h b/sound/soc/amlogic/meson/i2s.h
index ac8e725155bd..5ed94fb1be0a 100644
--- a/sound/soc/amlogic/meson/i2s.h
+++ b/sound/soc/amlogic/meson/i2s.h
@@ -59,6 +59,15 @@ struct aml_audio_buffer {
 	int cached_sample;
 };
 
+struct audio_mixer_control {
+	struct class aml_i2s_class;
+	int output_devide;
+	int input_device;
+	int direction;
+	int input_volume;
+	int output_volume;
+};
+
 struct aml_i2s_dma_params {
 	char *name;			/* stream identifier */
 	struct snd_pcm_substream *substream;
-- 
2.11.0

