From 289403e0b733e2542dee609147d3c402610ec9eb Mon Sep 17 00:00:00 2001
From: Matthew Shyu <matthew.shyu@amlogic.com>
Date: Mon, 27 May 2019 01:09:06 -0700
Subject: [PATCH] workaround for emmc eyetest fail

---
 drivers/amlogic/mmc/aml_sd_emmc_v3.c | 23 ++++++++++++++++++++++-
 1 file changed, 22 insertions(+), 1 deletion(-)

diff --git a/drivers/amlogic/mmc/aml_sd_emmc_v3.c b/drivers/amlogic/mmc/aml_sd_emmc_v3.c
index aabfd06..1a633a1 100644
--- a/drivers/amlogic/mmc/aml_sd_emmc_v3.c
+++ b/drivers/amlogic/mmc/aml_sd_emmc_v3.c
@@ -1662,10 +1662,31 @@ int aml_emmc_hs200_tl1(struct mmc_host *mmc)
 			pdata->align[9]);
 	writel(0, host->base + SD_EMMC_DELAY2_V3);
 	writel(clk_bak, host->base + SD_EMMC_CLOCK_V3);
+
+	delay2 = 0;
+	for (i = 0; i < 63; i++) {
+		retry_times = 0;
+		delay2 += (1 << 24);
+		writel(delay2, host->base + SD_EMMC_DELAY2_V3);
+retry1:
+		err = emmc_eyetest_log(mmc, 9);
+		if (err)
+			continue;
+
+		count = fbinary(pdata->align[9]);
+		if (count >= 8) {
+			if (retry_times != 3) {
+				retry_times++;
+				goto retry1;
+			} else
+				break;
+		}
+	}
+
 	pr_info("[%s][%d] clk config:0x%x\n",
 		__func__, __LINE__, readl(host->base + SD_EMMC_CLOCK_V3));
-	return 0;
 
+	return 0;
 }
 
 int __attribute__((unused)) aml_emmc_hs200_timming(struct mmc_host *mmc)
-- 
2.7.4

