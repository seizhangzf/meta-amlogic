From 01dc0607bed1abc9e7dfbc5caeb2fb08f05c8483 Mon Sep 17 00:00:00 2001
From: Pengcheng Chen <pengcheng.chen@amlogic.com>
Date: Wed, 11 Oct 2017 11:06:34 +0800
Subject: [PATCH 10/16] osd: null pointer risk protect

PD#151241: null pointer risk protect

driver defect clean up:
#284

Change-Id: I05ffb3df451b0f62de0ef00a688edc6bc33b1964
Signed-off-by: Pengcheng Chen <pengcheng.chen@amlogic.com>
---
 drivers/amlogic/media/osd/osd_fb.c | 13 +++++++------
 1 file changed, 7 insertions(+), 6 deletions(-)

diff --git a/drivers/amlogic/media/osd/osd_fb.c b/drivers/amlogic/media/osd/osd_fb.c
index 0c5179612c92..10a85994c0b2 100644
--- a/drivers/amlogic/media/osd/osd_fb.c
+++ b/drivers/amlogic/media/osd/osd_fb.c
@@ -1276,7 +1276,7 @@ static int osd_mmap(struct fb_info *info, struct vm_area_struct *vma)
 		fbdev->fb_mem_vaddr = fb_rmem_vaddr[fb_index];
 		if (!fbdev->fb_mem_vaddr) {
 			osd_log_err("failed to ioremap frame buffer\n");
-			ret = -ENOMEM;
+			return -ENOMEM;
 		}
 		osd_log_info("Frame buffer memory assigned at");
 		osd_log_info(" %d, phy: 0x%p, vir:0x%p, size=%dK\n\n",
@@ -1317,7 +1317,8 @@ static int osd_mmap(struct fb_info *info, struct vm_area_struct *vma)
 			osd_log_info("---------------clear fb%d memory %p\n",
 				fb_index, fbdev->fb_mem_vaddr);
 			set_logo_loaded();
-			memset(fbdev->fb_mem_vaddr, 0x0, fbdev->fb_len);
+			if (fbdev->fb_mem_vaddr)
+				memset(fbdev->fb_mem_vaddr, 0x0, fbdev->fb_len);
 			if (fb_index == DEV_OSD0 && osd_get_afbc()) {
 				for (j = 1; j < OSD_MAX_BUF_NUM; j++) {
 					osd_log_info(
@@ -1333,10 +1334,10 @@ static int osd_mmap(struct fb_info *info, struct vm_area_struct *vma)
 				 * 1. the big buffer ion alloc
 				 * 2. reserved memory
 				 */
-
-				memset(fb_rmem_vaddr[fb_index],
-						0x0,
-						fb_rmem_size[fb_index]);
+				if (fb_rmem_vaddr[fb_index])
+					memset(fb_rmem_vaddr[fb_index],
+							0x0,
+							fb_rmem_size[fb_index]);
 			}
 			/* setup osd if not logo layer */
 			osddev_setup(fbdev);
-- 
2.11.0

