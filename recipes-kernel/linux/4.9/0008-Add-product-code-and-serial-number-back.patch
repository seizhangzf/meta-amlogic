From c8efe04e45080800d4f24892d1ff82d040dce5fe Mon Sep 17 00:00:00 2001
From: Matthew Shyu <matthew.shyu@amlogic.com>
Date: Wed, 12 Jul 2017 14:54:44 +0800
Subject: [PATCH] Add product code and serial number back

Signed-off-by: Matthew Shyu <matthew.shyu@amlogic.com>
---
 .../media/vout/hdmitx/hdmi_tx_20/hdmi_tx_edid.c    | 36 ++++++++++++++++++++++
 .../amlogic/media/vout/hdmi_tx/hdmi_tx_module.h    |  2 ++
 2 files changed, 38 insertions(+)

diff --git a/drivers/amlogic/media/vout/hdmitx/hdmi_tx_20/hdmi_tx_edid.c b/drivers/amlogic/media/vout/hdmitx/hdmi_tx_20/hdmi_tx_edid.c
index ffea922fb1b1..cf3e554fe5d3 100644
--- a/drivers/amlogic/media/vout/hdmitx/hdmi_tx_20/hdmi_tx_edid.c
+++ b/drivers/amlogic/media/vout/hdmitx/hdmi_tx_20/hdmi_tx_edid.c
@@ -136,6 +136,28 @@ static void Edid_ReceiverBrandNameParse(struct rx_cap *pRxCap,
 		pRxCap->ReceiverBrandName[i] = uppercase[brand[i] - 1];
 }
 
+static void Edid_ParsingIDProductCode(struct rx_cap *pRXCap,
+		unsigned char *data)
+{
+	if (data == NULL)
+		return;
+	pRXCap->IDProductCode[0] = data[1];
+	pRXCap->IDProductCode[1] = data[0];
+	return;
+}
+
+static void Edid_ParsingIDSerialNumber(struct rx_cap *pRXCap,
+		unsigned char *data)
+{
+	int i;
+
+	if (data == NULL)
+		return;
+	for (i = 0; i < 4; i++)
+		pRXCap->IDSerialNumber[i] = data[3-i];
+	return;
+}
+
 static int Edid_find_name_block(unsigned char *data)
 {
 	int ret = 0;
@@ -1772,6 +1794,8 @@ int hdmitx_edid_parse(struct hdmitx_dev *hdmitx_device)
 	}
 
 	Edid_ReceiverBrandNameParse(&hdmitx_device->RXCap, &EDID_buf[8]);
+	Edid_ParsingIDProductCode(&hdmitx_device->RXCap, &EDID_buf[0x0A]);
+	Edid_ParsingIDSerialNumber(&hdmitx_device->RXCap, &EDID_buf[0x0C]);
 
 	idx[0] = EDID_DETAILED_TIMING_DES_BLOCK0_POS;
 	idx[1] = EDID_DETAILED_TIMING_DES_BLOCK1_POS;
@@ -2322,6 +2346,18 @@ int hdmitx_edid_dump(struct hdmitx_dev *hdmitx_device, char *buffer,
 
 	pos += snprintf(buffer+pos, buffer_len-pos,
 		"Rx Brand Name: %s\n", pRXCap->ReceiverBrandName);
+
+	pos += snprintf(buffer+pos, buffer_len-pos,
+		"Rx Product Code: %02x%02x\n",
+		pRXCap->IDProductCode[0],
+		pRXCap->IDProductCode[1]);
+	pos += snprintf(buffer+pos, buffer_len-pos,
+		"Rx Serial Number: %02x%02x%02x%02x\n",
+		pRXCap->IDSerialNumber[0],
+		pRXCap->IDSerialNumber[1],
+		pRXCap->IDSerialNumber[2],
+		pRXCap->IDSerialNumber[3]);
+
 	pos += snprintf(buffer+pos, buffer_len-pos,
 		"Rx Product Name: %s\n", pRXCap->ReceiverProductName);
 
diff --git a/include/linux/amlogic/media/vout/hdmi_tx/hdmi_tx_module.h b/include/linux/amlogic/media/vout/hdmi_tx/hdmi_tx_module.h
index 02b65816b493..4fc9ece8be0f 100644
--- a/include/linux/amlogic/media/vout/hdmi_tx/hdmi_tx_module.h
+++ b/include/linux/amlogic/media/vout/hdmi_tx/hdmi_tx_module.h
@@ -87,6 +87,8 @@ struct rx_cap {
 	unsigned char hdr_lum_avg;
 	unsigned char hdr_lum_min;
 	unsigned char ReceiverBrandName[4];
+	unsigned char IDProductCode[2];
+	unsigned char IDSerialNumber[4];
 	unsigned char ReceiverProductName[16];
 	unsigned char manufacture_week;
 	unsigned char manufacture_year;
-- 
2.11.0

